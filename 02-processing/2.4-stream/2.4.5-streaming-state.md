# 2.4.5 Streaming State

이번 챕터에서는 State 를 어떻게 만들고, State 가 Spark Streaming 에서 관리되는지를 알아봅니다.



### State

State 는 Spark 가 Executor 메모리에 유지하는 '상태' 를 말합니다. 다음 연산들을 사용할 경우에 State 가 만들어집니다.

* Join
* Aggregation
* Window
* Arbitrary Stateful Operation

Join, Aggregation (Group By), Window 의 경우에는 사용자가 Spark 의 함수를 사용해서 State 를 비명시적으로 만들게 됩니다.

Arbitrary Stateful Operation 이란 사용자가 명시적으로 '**State**' 를 만드는 방법입니다. Direct Streaming / Structured Streaming 각각 다음의 API 를 이용할 수 있습니다.

* (Direct Streaming) [DStream.updateStateByKey](https://spark.apache.org/docs/latest/streaming-programming-guide.html#updatestatebykey-operation), [DStream.mapWithState](https://github.com/apache/spark/blob/master/examples/src/main/scala/org/apache/spark/examples/streaming/StatefulNetworkWordCount.scala#L69)
* (Structured Streaming) [mapGroupsWithState / flatMapGroupsWithState](https://spark.apache.org/docs/latest/structured-streaming-programming-guide.html#arbitrary-stateful-operations)
  * [Scala API](https://spark.apache.org/docs/latest/api/scala/org/apache/spark/sql/streaming/GroupState.html)
  * [Scala Session Example](https://github.com/apache/spark/blob/v3.2.0/examples/src/main/scala/org/apache/spark/examples/sql/streaming/StructuredSessionization.scala)



{% hint style="info" %}
DStream 에서는 1.6 이후 로 mapWithState API 가 추가되었습니다. updateStateByKey 와 어떤 차이점이 있는지 다음 문서를 통해 알아봅시다.

* [Spark Stateful Stream Processing with mapWithState](https://www.linkedin.com/pulse/spark-stateful-stream-processing-mapwithstate-ajay-mall)
* [Exploring Stateful Streaming with Apache Spark](https://blog.yuvalitzchakov.com/exploring-stateful-streaming-with-apache-spark/)
{% endhint %}



사용자가 State 가 없는 연산 (단순 Filter, Map 등) 을 수행하는 것이 아니라 Join, Aggtegation, Window 를 통해 비명시적으로 혹은 `mapGroupsWithState` 와 같은 함수를 통해 명시적으로 State 를 사용할때 State 는 Executor 의 메모리에 존재합니다. _**만약 이 때 Executor 가 죽는다면 State 는 날라가서 복구되지 못하는 걸까요?**_


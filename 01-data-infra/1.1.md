---
description: Data Infrastructure
---

# 1.X 데이터 파이프라인

)이번 챕터에서는 데이터 파이프라인의 구성요소에 대해 이야기 합니다. 가상의 작은 회사 우동마켓을 가정하고, 우동마켓이 성장하면서 마주치는 문제들을 데이터 인프라 컴포넌트와 함께 하나씩 알아봅니다.

{% hint style="info" %}
우동마켓은 장류진 작가님의 소설 [일의 기쁨과 슬픔](http://www.yes24.com/Product/Goods/80742923) 속에 나온 가상의 스타트업입니다. 현실 세계에 존재하는 회사와는 관련이 없습니다.&#x20;
{% endhint %}



가상의 스타트업 우동마켓은 글로벌한 우동 서비스를 제공하려는 야욕을 가지고 있습니다. 면과 토핑, 국물 및 송송썰린 파와 같은 재료의 직판매 부터 시작해서 수 많은 우동 매니아를 위한 우동 추천 서비스, 비행기 입국장에서 사용자를 노려 국내 유수의 우동집을 홍보하는 타게팅까지를 목표로 하고 있습니다.&#x20;

이른바 "우동 커머스" 를 제공하려는, AWS 를 사용하는 초기 단계의 우동 스타트업의 데이터 파이프라인이 어떨지 논의해 봅시다.



### 초기 단계&#x20;

초기 단계의 우동마켓은 데이터 엔지니어가 필요 없을지 모릅니다.

* AWS 내에 [RDS](https://aws.amazon.com/rds/?p=pm\&c=db\&z=3), Redis (세션 등 용도) 와 같은 필수 저장소만 사용하고 있고&#x20;
* 아직은 기능을 만드는데 바빠 상품 검색은 MySQL 에서 LIKE 검색을
* 추천 상품은 단순히 판매건 기준으로 정렬해 Top 10 만 내보내고 있습니다

\[그림] 우동마켓 초기 인프라 (AWS VPC 내 RDS, EC, EC2 정도)



이때 우동마켓의 개발자 출신 CEO 로부터 첫 번째 데이터 요건이 들어옵니다.

* 데이터를 보고 싶다
* 실시간이면 좋겠다
* 개발자들은 기능 만드는데 바쁘니 쿼리보다는 UI 를 통해 이런저런 데이터를 보거나 가공할 수 있어야 한다



가장 쉬운 방법은 실제 서비스 DB 에 붙어 데이터를 보는것입니다. 물론 당연히 (...) 그러면 안됩니다. 따라서 AWS RDS 에 [Read Replica](https://aws.amazon.com/ko/rds/features/read-replicas/) 를 이용하면 (데이터가 적은 우동마켓의 경우에는) 아주 약간의 지연이 있을뿐, 실제 서비스 DB 를 실시간 / 비동기로 복제해 데이터를 확인할 수 있습니다.&#x20;

![AWS RDS 읽기 전용 복제본 (https://aws.amazon.com/ko/rds/features/read-replicas)](<../.gitbook/assets/image (2).png>)

[AWS Aurora](https://aws.amazon.com/ko/rds/aurora/?aurora-whats-new.sort-by=item.additionalFields.postDateTime\&aurora-whats-new.sort-order=desc) 를 RDB 로 사용한다면 내부적으로는 조금 다르게 동작할 수 있으나 마찬가지로 [Aurora Read Replica](https://docs.aws.amazon.com/ko\_kr/AmazonRDS/latest/AuroraUserGuide/Aurora.Replication.html) 를 추가할 수 있습니다.&#x20;



이렇게 추가된 읽기 전용 DB 에 우동마켓 내부 직원들이 사용하기 편리한 데이터 탐색 도구를 선정해 붙일 수 있습니다.&#x20;

* [AWS Quicksight](https://docs.aws.amazon.com/ko\_kr/quicksight/latest/user/how-quicksight-works.html) 와 같은 클라우드 관리형 도구를 사용하거나
* [Metabase](https://www.metabase.com) 처럼 쉽게 드래그 & 드랍을 통해 누적 차트와 대시보드를 쉽게 만들 수 있는 오픈소스 도구를 활용하거나
* [Retool](https://retool.com) 과 같이 내부 사용자 Admin 을 개발 없이 빠르게 보는 도구를 사용할 수도 있습니다.
* [Redash](https://redash.io) 를 사용한다면 DB 뿐만 아니라 구글스프레드시트 등 다양한 도구와 연동되며, 내부 사용자들이 쿼리를 작성하고, 쉽게 공유하고 그것으로 대시보드를 만들 수 있습니다.
* 이외에도 [Superset](https://superset.apache.org) 이나 [Tableau](https://www.tableau.com/ko-kr) 와 같은 도구들은 데이터를 '한번 더' 가공해 깔끔하게 만든 뒤 대시보드에 다양한 기능을 넣고 꾸미는 기능에 강점이 있기도 합니다.

도구는 회사 내부 사용자들의 생산성을 결정하므로, 적절한 도구를 선택해 제공할 수 있습니다.&#x20;

일반적으로는 여러 종류의 DB (RDB, NoSQL) 는 물론 구글 시트 등 다양한 시스템과 연동되고 다른 사람이 작성한 쿼리 / 대시보드 등을 쉽게 검색하고 재활용할 수 있으며 운영성으로 대용량 CSV 다운로드가 가능한 Redash 가 많이 쓰이는 편입니다.&#x20;

필요하다면 여러 도구를 제공하는 것도 물론 가능합니다. 다만 늘 그렇듯이, 해당 시스템을 운영하는 엔지니어의 노동 비용 그리고 머신 값으로 지불해야 할 물리 비용, 사내 사용자들의 학습 부하 및 데이터 활용의 집중이 아니라 분산 (다양한 도구 사용시) 이 발생할 수 있으므로 적절한 한도 내에서 몇몇 도구를 사용할지 결정하면 됩니다.

{% hint style="info" %}
여러분이 도입하는 모든 데이터 도구는, 데이터로 일하는 회사 구성원 전부의 생산성에 영향을 미칩니다. 따라서 단순히 '이 기능이 좋아' 보다는 다음 내용들을 고려하여 제공해야 합니다.

* 여러 시스템과의 연동
* 코드 수정 및 확장 가능성
* 다양한 활용처: 대용량 CSV 데이터 다운로드 / 데이터 탐색 / 대시보드 등
{% endhint %}



\[그림] Read Replica 에 다양한 도구를 붙이는 경우



데이터 탐색 도구를 DB 에 붙이면 이제 준 실시간으로 (Read Replica 의 지연을 제외하면) 서비스의 데이터를 볼 수 있습니다. 그러나 몇 가지 제한점이 존재합니다.&#x20;

* 우동마켓은 그 자그마한 서비스 규모에 걸맞지 않게, MSA 를 하느라 DB 를 여러개 사용합니다. DB 가 여러개이므로 DB 내에서 Join 이 불가능합니다.
* 우동마켓은 RDB 이외에도 [Elasticache](https://aws.amazon.com/ko/elasticache/) (AWS managed ElasticSearch) 와 AWS OpenSearch (AWS 관리형 ElasticSearch) 를 사용합니다.&#x20;
* 우동마켓의 서비스 DB 인 RDB 는 사용할 수 있는 Query 문법이 별로 신통치 않습니다. MySQL 특정 버전 이후부터 With Clause Window Function, JSON Function, Spatial Function 이 지원됩니다. 다만 그정도이지, Unnest 등 다양한 패턴을 일관되고 사용성 높은 함수로 지원하지 못합니다. 게다가 문법이 다른 MySQL 이외의 DB 를 인수합병, 너와 내가 사이가 나빠 시작하는 MSA 등으로 도입하는 순간 쿼리 사용자는 지옥으로 가게됩니다.



따라서 다음의 요구사항을 충족하는 범용, 대규모 처리 쿼리 엔진이 필요합니다.

* 다양한 스토리지 (RDB, NoSQL) 를 지원하고 서로 다른 스토리지의 데이터를 Join 할 수 있습니다.
* 스토리지에 상관 없이 일관되고 사용성이 편리한 SQL 문법을 제공합니다.
* 대규모 데이터를 메모리에서 빠르게 처리할 수 있습니다.

[Apache Presto](1.1.md#undefined) 는 이런 용도를 위해 설계된 범용, 대규모 쿼리 엔진입니다. AWS 에서는 [EMR](https://docs.aws.amazon.com/emr/latest/ReleaseGuide/emr-presto.html) 위에서 편리하게 사용할수 있습니다. 만약 직접 운영하지 않는다면 [AWS Athena](https://docs.aws.amazon.com/athena/latest/ug/what-is.html) 와 같은 관리형 서비스를 사용할 수 있습니다. ([Athena 는 Presto 를 기반으로 만들어졌습니다.](https://aws.amazon.com/ko/athena/faqs/))

![Presto Connector Overview (https://prestodb.io/overview.html)](<../.gitbook/assets/image (1).png>)



Presto 를 이용하면 다양한 커넥터를 붙여 SQL 을 이용해 Join 하고 가공할 수 있습니다. 예를 들어,&#x20;

```sql
SELECT AIRPORT.name as airport_name, count(*) as flight_count
FROM hive.flight_history.flights FLIGHT
JOIN mysql.flight_meta.airport AIRPORT 
  ON FLIGHT.code = AIRPORT.airport_code
GROUP BY AIRPORT.name
ORDER BY flight_count
LIMIT 100
```





테이블은 크게 두 가지 경우로 분류

* State (변경됨)
* History (변경되지 않음)

테이블이 무한히 커질 수 없으므로 어느 시점에는 실시간 DB 를 붙기 어려울 수 있음

보관 / 휴면 / 암호화 / 개인정보



\[그림] RDS 데이터를 주기적으로 퍼오는 그림 S3

RDS Exporter

{% hint style="info" %}
RDS Exporter 가 원하는 기능을 처음부터 제공하지 않을수도

미래에도 원하는 기능을 제공하지 않을수도 주기 / 컴퓨팅 속도 / 추출 컬럼 컨버팅 등&#x20;

직접 만들어야?
{% endhint %}



&#x20;





Client (앱 / 웹) 의 사용자는 아직 존재하지 않기 때문에 볼 수 없습니다.&#x20;

\[그림] 사용자 데이터 시나리오&#x20;

* Kinesis
* API / Kafka



\[그림] 실시간 사용자 데이터 처리&#x20;



또한 서버로부터 실시간 로그

\[그림] 서버 실시간 데이터 처리



\[그림]&#x20;











